<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G6 Cafe - Checkout</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
  {% include "header.html" %}
	<!-- Checkout Form -->
	<div class="checkout-container">
		<form id="checkout-form" class="checkout-form" action="{{ url_for('proceed_checkout') }}" method="POST">
			<div class="checkout">
			<h2>Checkout</h2>
			<div id="pickupDetails" style="display: none;">
				<h3>Selected Branch</h3>
				<a href="{{ url_for('stores') }}" class="change-store-link">
				<img src="static/images/pencil.png" alt="Edit" class="edit-icon" id="edit-pickup-icon"></a>
				<p id="pickup-location">Pick up your order from the selected store.</p>
			</div>
					<!-- Pick Up & Delivery Option -->
				<h3>Order Type</h3>
				<label>
					<input type="radio" name="order_type" value="pick_up"> Pick-Up
					<input type="radio" name="order_type" value="delivery"> Delivery
				</label>

				<div id="pick_up_options" style="display: none;">
					<label>
						<input type="radio" name="option" value="standard"> Pick-up Now
					</label>
					<label>
						<input type="radio" name="option" value="scheduled"> Pick up later
						<input type="date" name="pickup_date">
						<input type="time" name="pickup_time">
					</label>
				</div>
					<div id="delivery_options" style="display: none;">
					<label>
						<input type="radio" name="option" value="delivery"> Delivery Now
					</label>
					<label>
						<input type="radio" name="option" value="scheduled_delivery"> Delivery Later
						<input type="date" name="delivery_date">
						<input type="time" name="delivery_time">
					</label>

					<div id="delivery_address_section" style="display: none;">
						<h4>Delivery Address</h4>
						<input type="text" name="address" placeholder="Enter your address" required>
						<h4>Delivery Instruction</h4>
						<input type="text" name="delivery-instruction" placeholder="Enter your instruction" >
					</div>
				</div>
					<!-- Personal Details -->
				<h3>Personal Details</h3>
				<label>Name: <input type="text" name="name" required></label>
				<label>Email: <input type="email" name="email"></label>
				<label>Contact Number: <input type="tel" name="contact" required></label>

				<!-- PWD/Senior Citizen Discount Section -->
				<h3>PWD/Senior Citizen Discount</h3>
				<label>
					<input type="radio" name="discount-option" id="pwd-radio" value="PWD"> PWD
					<input type="radio" name="discount-option" id="senior-radio" value="Senior"> Senior Citizen
				</label>
				<div id="discount-details" style="display:none;">
					<label>Full Name: <input type="text" name="discount_name" id="discount_name" placeholder="Enter your full name"></label>
					<label>ID Number: <input type="text" name="discount_id_number" id="discount_id_number" placeholder="Enter your ID number"></label>
				</div>

				<!-- Payment Details -->
				<h3>Payment Option</h3>
				<label>
					<input type="radio" name="payment" value="cash" id="cash-payment" required>
					<span>Cash</span>
				</label>
				<!-- Tendered Amount Section (initially hidden) -->
				<div id="tendered-amount-section" style="display: none; margin-left: 20px;">
					Tendered Amount: <input type="number" name="tendered_amount" id="tendered_amount" placeholder="Enter tendered amount">
				</div>

				<label>
					<input type="radio" name="payment" value="gcash">
					<span>GCash (Pay online)</span>
				</label>
				<div id="gcash-number-section" style="display: none; margin-left: 20px;">
					<label>Gcash Number <input type="text" name="gcash-number" id="gcash-number" placeholder="Enter Gcash number"></label>
					<span id="gcash-error" style="color: red; display: none;">Please enter a valid 11-digit phone number.</span>
				</div>
				<label>
					<input type="radio" name="payment" value="debit/creditcard">
					<span>Debit/Credit Card (Pay online)</span>
				</label>


				<!-- Card Details (hidden by default) -->
				<div id="card-details" class="payment-details" hidden="hidden">
					<h4>Card Details</h4>
					<label>Name on Card: <input type="text" name="card_name" placeholder="Full Name on Card" id="card_name" required></label>
					<label>Card Number: <input type="text" name="card_number" placeholder="1234 5678 9012 3456" id="card_number" required></label>
					<div class="expiration-container">
						<label>Expiration Month:
							<select name="expiration_month" required>
								<option value="01">01</option>
								<option value="02">02</option>
								<option value="03">03</option>
								<option value="04">04</option>
								<option value="05">05</option>
								<option value="06">06</option>
								<option value="07">07</option>
								<option value="08">08</option>
								<option value="09">09</option>
								<option value="10">10</option>
								<option value="11">11</option>
								<option value="12">12</option>
							</select>
						</label>
						<label>Expiration Year:
							<select name="expiration_year" required>
								<option value="2024">2024</option>
								<option value="2025">2025</option>
								<option value="2026">2026</option>
								<option value="2027">2027</option>
								<option value="2028">2028</option>
								<option value="2029">2029</option>
								<option value="2030">2030</option>
								<option value="2031">2031</option>
								<option value="2032">2032</option>
							</select>
						</label>
					</div>
					<label>CVV: <input type="text" name="cvv" id="cvv" maxlength="3" placeholder="CVV" required></label>
				</div>
		<button type="button" id="place_order">Place Order</button>
		<div id="thankYouModal" class="modal" style="display: none;">
			<div class="modal-content">
				<img src="/static/images/check.png" alt="Checkmark" style="width: 60px; height: 60px; display: block; margin: 20px auto 0 auto;">
				<h2>Thank you for your Order!</h2>
				<p>We have received your order and have sent you a text <br> message confirmation to {{ customer_phone_number }}.</p>
				<button type="button" id="confirmSubmit">OK</button>
			</div>
		</div>
	</div>
			<div id="hiddenCartListContainer" hidden="hidden">
				<input type="text" name="subtotal" id="subtotal_hidden" />
				<input type="text" name="vat" id="vat_hidden" />
				<input type="text" name="discount" id="discount_hidden" />
				<input type="text" name="amount_due" id="amount_due_hidden" />
				<input type="text" name="change_value" id="change_value_hidden" />
			</div>
		</form>
		<div class="order-summary">
			<div class="order-info">
				<h3>Order Details</h3>
		</div>
		<table class="order-details-table" id="order-details-table">
			<thead>
				<tr>
					<th>Item</th>
					<th>Quantity</th>
					<th>Price</th>
					<th>Subtotal</th> <!-- Added header for Subtotal -->
				</tr>
			</thead>
			<tbody id="item-list">
				<!-- Item rows will be added here dynamically -->
			</tbody>
		</table>
		<div id="order-summary"></div>
			<div class="order-details">
				<p>Total Items: <span id="total-items">0</span></p>
				<p>Subtotal: <span id="Subtotal">P0.00</span></p>
				<p>Vat: <span id="vat">P0.00</span></p>
				<p>PWD/SENIOR Discount: <span id="discount">P0.00</span></p>
				<p>Amount Due: <span id="amount-due">P0.00</span></p>
				<p id="change-amount">Change: <span id="change-value">P0.00</span></p>
			</div>
		</div>
	</div>


{% include "footer.html" %}
</body>
</html>

<script>
    document.addEventListener("DOMContentLoaded", () => {
    const optionRadioButtons = document.querySelectorAll('input[name="option"]');
    const pickupDetailsSection = document.getElementById('pickupDetails');
    const optionButtons = document.querySelectorAll('.option-button');
    const addressSection = document.getElementById('address');
    const orderTypeRadios = document.querySelectorAll('input[name="order_type"]');
    const pickUpOptions = document.getElementById("pick_up_options");
    const deliveryOptions = document.getElementById("delivery_options");
    const deliveryAddressSection = document.getElementById("delivery_address_section");
    const paymentRadioButtons = document.querySelectorAll('input[name="payment"]');
    const cardDetailsSection = document.getElementById("card-details");
	const pwdRadio = document.getElementById('pwd-radio');
    const seniorRadio = document.getElementById('senior-radio');
    const discountDetails = document.getElementById('discount-details');
    const discountNameInput = document.getElementById('discount_name');
    const discountIdInput = document.getElementById('discount_id_number');
    const orderSummary = document.getElementById('order-summary');

    const cashPaymentRadio = document.getElementById("cash-payment");
    const gcashPaymentRadio = document.getElementById("gcash-payment");
    const gcashSection = document.getElementById('gcash-number-section');
    const gcashNumberInput = document.getElementById('gcash-number');

    const tenderedAmountSection = document.getElementById("tendered-amount-section");
    const tenderedAmountInput = document.getElementById("tendered_amount");
    const changeDisplay = document.getElementById('change-value');

    const cardNameInput = document.getElementById('card_name');
    const cardNumberInput = document.getElementById('card_number');
    const cvvInput = document.getElementById('cvv');

    const placeOrderButton = document.getElementById('place_order');
    const confirmButton = document.getElementById('confirmSubmit');


     // Event listener for order type selection
    orderTypeRadios.forEach(radio => {
        radio.addEventListener("change", function () {
            if (this.value === "delivery") {
                // Show delivery options
                deliveryOptions.style.display = "block";
                pickUpOptions.style.display = "none";
            } else if (this.value === "pick_up") {
                // Show pick-up options
                pickUpOptions.style.display = "block";
                deliveryOptions.style.display = "none";
                deliveryAddressSection.style.display = "none"; // Hide delivery address
            }
        });
    });

    // Event listener for delivery options
    deliveryOptions.addEventListener("change", (event) => {
        if (event.target.name === "option") {
            if (event.target.value === "delivery" || event.target.value === "scheduled_delivery") {
                deliveryAddressSection.style.display = "block"; // Show delivery address
            } else {
                deliveryAddressSection.style.display = "none"; // Hide delivery address
            }
        }
    });


    // Initialize the page and load data
    initialize();

    function initialize() {
        setupEventListeners();
        loadCart();
        displaySelectedStore();
    }
 function displayStoreDetails() {
    const storeDetails = localStorage.getItem('selectedStore');

    if (storeDetails) {
        try {
            const store = JSON.parse(storeDetails);
            const pickupDetails = document.getElementById('pickupDetails');
            const pickupLocation = document.getElementById('pickup-location');

            if (store.name && store.address) {
                pickupLocation.textContent = `${store.name}, located at ${store.address}.`;
                pickupDetails.style.display = 'block';
            } // Close if statement here
        } catch (error) {
            console.error("Error parsing store details:", error);
        }
    }
}


function editPickUpLocation() {
    console.log('Edit pick-up location triggered'); // Debug log

    // Get the current pick-up location value
    let currentLocation = document.getElementById('pickup-location').innerText;
    console.log('Current location:', currentLocation); // Debug log

    // Prompt user with a confirmation dialog (OK/Cancel)
    let changeLocation = confirm('Do you want to change the pick-up location?');

    // If the user clicked OK, allow them to select a new location or handle this logic
    if (changeLocation) {
        // Redirect to store pick-up location page to choose a new store
        const storePickUpUrl = "/stores"; // Adjust the URL as needed

        console.log('Redirecting to:', storePickUpUrl); // Debug log

        // Save the current location temporarily before redirection (optional)
        localStorage.setItem('previousPickupLocation', currentLocation);

        // Redirect to the store pick-up page
        window.location.href = storePickUpUrl;
    }
}

// Attach click event to the pencil icon
document.addEventListener('DOMContentLoaded', () => {
    const editIcon = document.getElementById('edit-pickup-icon');
    if (editIcon) {
        console.log('Edit icon found. Adding click event listener.'); // Debug log
        editIcon.addEventListener('click', editPickUpLocation);
    } else {
        console.error('Edit icon not found in the DOM.');
    }
});

// Call the function on page load
window.onload = displayStoreDetails;

    function displaySavedAddress() {
        if (!addressSection) {
            console.error("Element with ID 'address' not found.");
            return;
        }

        const storedDetails = JSON.parse(localStorage.getItem('deliveryDetails'));
        if (storedDetails) {
            const address = `${storedDetails.houseNumber} ${storedDetails.streetName}, ${storedDetails.subdivisionName ? storedDetails.subdivisionName + ', ' : ''}${storedDetails.barangay}, ${storedDetails.city}`;
            addressSection.textContent = address;
        } else {
            addressSection.textContent = 'No address saved';
        }
    }

    function displaySavedDeliveryInstruction() {
        const deliveryInstructionElement = document.getElementById('deliveryInstruction');
        if (!deliveryInstructionElement) {
            console.error("Element with ID 'deliveryInstruction' not found.");
            return;
        }

        const storedDetails = JSON.parse(localStorage.getItem('deliveryDetails'));
        if (storedDetails && storedDetails.deliveryInstruction) {
            deliveryInstructionElement.textContent = storedDetails.deliveryInstruction;
        } else {
            deliveryInstructionElement.textContent = 'No instructions provided';
        }
    }

    function displaySelectedStore() {
        if (!pickupDetailsSection) {
            console.error("Element with ID 'pickupDetails' not found.");
            return;
        }

        const selectedStore = localStorage.getItem('selectedStore');
        if (selectedStore) {
            try {
                const storeDetails = JSON.parse(selectedStore);
                const storeDetailsText = `${storeDetails.name}, ${storeDetails.location}`;
                pickupDetailsSection.style.display = 'block';

                const pickupLocationElement = document.getElementById('pickup-location');
                if (pickupLocationElement) {
                    pickupLocationElement.textContent = storeDetailsText;
                } else {
                    console.error("Element with ID 'pickup-location' not found.");
                }
            } catch (error) {
                console.error("Error parsing selectedStore from localStorage:", error);
            }
        } else {
            pickupDetailsSection.style.display = 'none';
        }
    }

   function toggleOptions(option) {
        console.log('Selected option:', option);
        console.log('Delivery section:', deliveryDetailsSection);
        console.log('Pickup section:', pickupDetailsSection);
        console.log('Address section:', addressSection);

        if (option === 'delivery') {
            // Show delivery details and address
            deliveryDetailsSection.style.display = 'block';
            pickupDetailsSection.style.display = 'none';
            addressSection.style.display = 'block'; // If needed, show address
        } else if (option === 'pickup') {
            // Show pickup details and hide delivery
            deliveryDetailsSection.style.display = 'none';
            pickupDetailsSection.style.display = 'block';
            addressSection.style.display = 'none'; // Optionally hide address for pickup
        } else {
            console.error('Invalid option passed to toggleOptions.');
        }
    }

    // Set up event listeners for option buttons
    function setupEventListeners() {
        if (optionButtons.length === 0) {
        }

        optionButtons.forEach(button => {
            button.addEventListener('click', (event) => {
            event.preventDefault();
            console.log('Button clicked:', button);
                const option = this.classList.contains('deliveryBtn') ? 'delivery' : 'pickup';
                toggleOptions(option); // Call toggleOptions when a button is clicked
                localStorage.setItem('currentSelection', option);
            });
        });


		// Payment method change listener
		paymentRadioButtons.forEach(button => {
			button.addEventListener('change', function() {
				if (this.value === "debit/creditcard") {
					cardDetailsSection.style.display = 'block';
					cardNameInput.required = true;
					cardNumberInput.required = true;
					cvvInput.required = true;
				} else {
					cardDetailsSection.style.display = 'none';
					cardNameInput.required = false;
					cardNumberInput.required = false;
					cvvInput.required = false;
				}


				if (this.value !== "cash") {
					tenderedAmountSection.style.display = 'none';
					tenderedAmountInput.value = '';
					changeDisplay.style.display = 'none';
					changeDisplay.innerText = `P0.00`; // Reset change to 0
				} else {
					tenderedAmountSection.style.display = 'block';
					changeDisplay.style.display = 'block';
					changeDisplay.innerText = `P0.00`; // Ensure change is reset for cash payment
				}
				if (this.value === "gcash") {
					gcashSection.style.display = 'block';
					gcashNumberInput.required = false; // Make GCash number input required
					} else {
					gcashSection.style.display = 'none';
					gcashNumberInput.required = false;
					gcashNumberInput.value = '';
				}
			});
		 });

	function updateDiscountDetails() {
  console.log("PWD Checked:", pwdRadio.checked);
  console.log("Senior Checked:", seniorRadio.checked);

  // Show the discount details section if either radio button is checked
  if (pwdRadio.checked || seniorRadio.checked) {
    discountDetails.style.display = 'block';
    discountNameInput.placeholder = pwdRadio.checked ? "Enter your PWD full name" : "Enter your Senior full name";
    discountIdInput.placeholder = pwdRadio.checked ? "Enter your PWD ID number" : "Enter your Senior ID number";
  } else {
    // Hide the discount details section and clear the inputs if neither is checked
    discountDetails.style.display = 'none';
    discountNameInput.value = '';
    discountIdInput.value = '';
  }

  // Call loadCart to recalculate the cart
  loadCart();
}

// Event listeners to update details when either radio button is selected
pwdRadio.addEventListener('change', updateDiscountDetails);
seniorRadio.addEventListener('change', updateDiscountDetails);

// Optionally, reset radio buttons when clicking outside the discount section
document.addEventListener('click', function(event) {
  if (!event.target.closest('label')) {
    // Uncheck both if clicked outside the discount section
    pwdRadio.checked = false;
    seniorRadio.checked = false;
    discountDetails.style.display = 'none';
    discountNameInput.value = '';
    discountIdInput.value = '';

    // Recalculate the cart after unchecking
    loadCart();
  }
});

tenderedAmountInput.addEventListener('input', updateChangeDisplay);
    }
    function addMultipleKeyValuePairs(dataList, keyValuePairs) {
      dataList.push(Object.fromEntries(keyValuePairs));
      return dataList;
    }

    // Load cart items and update the order summary
    function loadCart() {
		const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
        const orderSummary = document.getElementById('order-summary');

        let totalItems = 0;
        let subtotal = 0;
        let vat = 0;
        let discount = 0;

        if (cartItems.length === 0) {
            orderSummary.innerHTML = '<p>Your cart is empty.</p>';
        } else {
            let orderSummaryHtml = '';

            cartItems.forEach(item => {
                const itemSubtotal = item.quantity * item.itemPrice;
                subtotal += itemSubtotal;
                totalItems += item.quantity;

                orderSummaryHtml += `
                   <div>
                    <p class="item-name">
                        ${item.itemName}
                        <span class="item-subtotal">P${itemSubtotal.toFixed(2)}</span>
                        <span class="item-price">P${item.itemPrice.toFixed(2)}</span>
                        <span class="item-quantity">${item.quantity}</span>
                    </p>
                    <p class="item-preference">${item.preferences ? item.preferences : "No preferences"}</p>
                </div>

                `;
            });

            if (pwdRadio.checked || seniorRadio.checked) {
                discount = subtotal * 0.20;
                vat = 0;
            } else {
                vat = subtotal * 0.12;
                discount = 0;
            }

            const totalAmount = subtotal + vat - discount;

            orderSummary.innerHTML = orderSummaryHtml;
            document.getElementById('total-items').innerText = totalItems;

            document.getElementById('Subtotal').innerText = `P${subtotal.toFixed(2)}`;
            document.getElementById('subtotal_hidden').value = subtotal.toFixed(2);

            document.getElementById('vat').innerText = `P${vat.toFixed(2)}`;
            document.getElementById('vat_hidden').value = vat.toFixed(2);

            document.getElementById('discount').innerText = `P${discount.toFixed(2)}`;
            document.getElementById('discount_hidden').value = discount.toFixed(2);

            document.getElementById('amount-due').innerText = `P${totalAmount.toFixed(2)}`;
            document.getElementById('amount_due_hidden').value = totalAmount.toFixed(2);
        }

        updateChangeDisplay();
    }

    // Update the change display based on the tendered amount
    function updateChangeDisplay() {
        tenderedAmountInput.addEventListener('input', function() {
            const tenderedAmount = parseFloat(this.value);
            const amountDue = parseFloat(document.getElementById('amount-due').innerText.replace('P', ''));

            if (!isNaN(tenderedAmount) && tenderedAmount >= amountDue) {
                const change = tenderedAmount - amountDue;
                changeDisplay.innerText = `P${change.toFixed(2)}`;
                document.getElementById('change_value_hidden').value = change.toFixed(2);
            } else if (!isNaN(tenderedAmount)) {
                changeDisplay.innerText = `Insufficient funds!`;
                document.getElementById('change_value_hidden').value = 0;
            } else {
                changeDisplay.innerText = `P0.00`;
                document.getElementById('change_value_hidden').value = 0;
            }
        });
    }
   // Event listener for the "Place Order" button
document.getElementById('place_order').addEventListener('click', function(event) {
    // Prevent form submission
    event.preventDefault();

    // Validate the form before showing the modal
    if (validateForm()) {
        // Show the modal if validation passes
        showModal();
    } else {
        alert('Please fill out all required fields.');
    }
});

// Show the modal function
function showModal() {
    const modal = document.getElementById('thankYouModal');
    modal.style.display = "block";
}

// Event listener for the "OK" button inside the modal
document.getElementById('confirmSubmit').addEventListener('click', function() {
    // Submit the form after confirmation
    document.getElementById('checkout-form').submit();

    // Close the modal after submitting the form
    closeModal();
});

// Close the modal function
function closeModal() {
    const modal = document.getElementById('thankYouModal');
    modal.style.display = "none";
}

// Form validation function
function validateForm() {
    const requiredFields = document.querySelectorAll('#checkout-form [required]');

    // Check if any required field is empty
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            field.focus();
            return false;  // Return false if a required field is empty
        }
    }

    // Check if an order type is selected (Pick-Up or Delivery)
    const orderType = document.querySelector('input[name="order_type"]:checked');
    if (!orderType) {
        alert('Please select an order type (Pick-Up or Delivery).');
        return false;
    }

    // Check if discount details are filled if a discount option is selected
    const discountOption = document.querySelector('input[name="discount-option"]:checked');
    if (discountOption) {
        const discountName = document.querySelector('input[name="discount_name"]').value.trim();
        const discountId = document.querySelector('input[name="discount_id_number"]').value.trim();
        if (!discountName || !discountId) {
            alert('Please fill out the discount details.');
            return false;
        }
    }

    // Check if delivery address is filled when required
    const deliveryOption = document.querySelector('input[name="option"]:checked');
    if (deliveryOption && (deliveryOption.value === 'scheduled_delivery' || deliveryOption.value === 'delivery')) {
        const address = document.querySelector('input[name="address"]').value.trim();
        if (!address) {
            alert('Please enter a delivery address.');
            return false;
        }
    }

    return true;  // Return true if all fields are valid
}

    // Initialize the cart when page loads
    loadCart();
  });
</script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>