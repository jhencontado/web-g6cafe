<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G6 Cafe - Checkout</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
  {% include "header.html" %}
	<!-- Checkout Form -->
	<div class="checkout-container">
		<form id="checkout-form" class="checkout-form" action="{{ url_for('proceed_checkout') }}" method="POST">
					<div class="checkout">
			<h2>Checkout</h2>

			<!-- Branch Selection Details (Initially hidden if a branch is selected) -->
			<div id="pickupDetails" style="display: none;">
				<h3>Selected Branch</h3>
				<a href="{{ url_for('stores') }}" class="change-store-link">
					<img src="static/images/pencil.png" alt="Edit" class="edit-icon" id="edit-pickup-icon">
				</a>
				<p id="pickup-location"></p>
			</div>

			<!-- Store Selection Prompt (Initially hidden if a store is selected) -->
				<div id="store-selection-prompt" style="display: none;">
				<a href="{{ url_for('stores') }}" class="select-store-link">
					<img src="static/images/pencil.png" alt="Edit" class="edit-icon" id="storeselection">
				</a>
					<p>Please select a local Store to proceed with your order.</p>
			</div>

					<!-- Pick Up & Delivery Option -->
				<h3>Order Type</h3>
				<label>
					<input type="radio" name="order_type" value="pick_up"> Pick-Up
					<input type="radio" name="order_type" value="delivery"> Delivery
				</label>

				<div id="pick_up_options" style="display: none;">
					<label>
						<input type="radio" name="option" id="standard" value="standard"> Pick-up Now
					</label>
					<label>
						<input type="radio" name="option" id="scheduled" value="scheduled" > Pick up later
						<input type="date" name="pickup_date" id="pickup_date">
						<input type="time" name="pickup_time" id="pickup_time">
					</label>
				</div>
				<div id="delivery_options" style="display: none;">
					<label>
						<input type="radio" name="option" id="deliver_now" value="deliver_now"> Deliver Now
					</label>
					<label>
						<input type="radio" name="option" id="scheduled_delivery" value="scheduled_delivery"> Deliver Later
						<input type="date" name="delivery_date" id="delivery_date">
						<input type="time" name="delivery_time" id="delivery_time">
					</label>

					<div id="delivery_address_section" style="display: none;">
						<h4>Delivery Address</h4>
						<input type="text" name="address" id="address" placeholder="Enter your address" required>
						<h4>Delivery Instruction</h4>
						<input type="text" name="delivery-instruction" id="delivery-instruction" placeholder="Enter your instruction" >
					</div>
				</div>

				<!-- Personal Details -->
				<h3>Personal Details</h3>
				<label>Name: <input type="text" name="name" required></label>
				<label>Email: <input type="email" name="email"></label>
				<label>Contact Number: <input type="tel" name="contact" required></label>

				<!-- PWD/Senior Citizen Discount Section -->
				<h3>PWD/Senior Citizen Discount</h3>
						<label>
					<input type="radio" name="discount-option" id="none-radio" value="None" checked> None
				</label>
				<label>
					<input type="radio" name="discount-option" id="pwd-radio" value="PWD"> PWD
				</label>
				<label>
					<input type="radio" name="discount-option" id="senior-radio" value="Senior"> Senior Citizen
				</label>

				<div id="discount-details" style="display:none;">
					<label>Full Name: <input type="text" name="discount_name" id="discount_name" placeholder="Enter your full name"></label>
					<label>ID Number: <input type="text" name="discount_id_number" id="discount_id_number" placeholder="Enter your ID number"></label>
				</div>

				<!-- Payment Details -->
				<h3>Payment Option</h3>
				<label>
					<input type="radio" name="payment" value="cash" id="cash-payment" required>
					<span>Cash</span>
				</label>
				<!-- Tendered Amount Section (initially hidden) -->
				<div id="tendered-amount-section" style="display: none; margin-left: 20px;">
					Tendered Amount: <input type="number" name="tendered_amount" id="tendered_amount" placeholder="Enter tendered amount">
				</div>

				<label>
					<input type="radio" name="payment" value="gcash">
					<span>GCash (Pay online)</span>
				</label>
				<div id="gcash-number-section" style="display: none; margin-left: 20px;">
					<label>Gcash Number <input type="text" name="gcash-number" id="gcash-number" placeholder="Enter Gcash number"></label>
					<span id="gcash-error" style="color: red; display: none;">Please enter a valid 11-digit phone number.</span>
				</div>
				<label>
					<input type="radio" name="payment" value="debit/creditcard">
					<span>Debit/Credit Card (Pay online)</span>
				</label>

				<!-- Card Details (hidden by default) -->
				<div id="card-details" class="payment-details" hidden="hidden">
					<h4>Card Details</h4>
					<label>Name on Card: <input type="text" name="card_name" placeholder="Full Name on Card" id="card_name" ></label>
					<label>Card Number: <input type="text" name="card_number" placeholder="1234 5678 9012 3456" id="card_number" ></label>
					<div class="expiration-container">
						<label>Expiration Month:
							<select name="expiration_month" >
								<option value="01">01</option>
								<option value="02">02</option>
								<option value="03">03</option>
								<option value="04">04</option>
								<option value="05">05</option>
								<option value="06">06</option>
								<option value="07">07</option>
								<option value="08">08</option>
								<option value="09">09</option>
								<option value="10">10</option>
								<option value="11">11</option>
								<option value="12">12</option>
							</select>
						</label>
						<label>Expiration Year:
							<select name="expiration_year" >
								<option value="2024">2024</option>
								<option value="2025">2025</option>
								<option value="2026">2026</option>
								<option value="2027">2027</option>
								<option value="2028">2028</option>
								<option value="2029">2029</option>
								<option value="2030">2030</option>
								<option value="2031">2031</option>
								<option value="2032">2032</option>
							</select>
						</label>
					</div>
					<label>CVV: <input type="text" name="cvv" id="cvv" maxlength="3" placeholder="CVV" ></label>
				</div>
				<button type="button" onclick="showModal()" id="place_order">Place Order</button>
			</div>
			<div id="hiddenCartListContainer" hidden="hidden">
				<input type="text" name="subtotal" id="subtotal_hidden" />
				<input type="text" name="vat" id="vat_hidden" />
				<input type="text" name="discount" id="discount_hidden" />
				<input type="text" name="amount_due" id="amount_due_hidden" />
				<input type="text" name="change_value" id="change_value_hidden" />
				<input type="text" name="store_name" id="store_name_hidden" />
				<div id="hidden-order-summary"></div>
			</div>
		</form>
		<div class="order-summary">
			<div class="order-info">
				<h3>Order Details</h3>
			</div>
			<table class="order-details-table" id="order-details-table">
				<thead>
					<tr>
						<th>Item</th>
						<th>Quantity</th>
						<th>Price</th>
						<th>Subtotal</th> <!-- Added header for Subtotal -->
					</tr>
				</thead>
				<tbody id="item-list">
					<!-- Item rows will be added here dynamically -->
				</tbody>
			</table>
			<div id="order-summary"></div>
			<div class="order-details">
				<p>Total Items: <span id="total-items">0</span></p>
				<p>Subtotal: <span id="Subtotal">P0.00</span></p>
				<p>Vat: <span id="vat">P0.00</span></p>
				<p>PWD/SENIOR Discount: <span id="discount">P0.00</span></p>
				<p>Amount Due: <span id="amount-due">P0.00</span></p>
				<p id="delivery-fee" style="display: none;">Delivery Fee: <span id="delivery-value">FREE</span></p>
				<p id="change-amount">Change: <span id="change-value">P0.00</span></p>
			</div>
		</div>
	</div>
        <!-- Thank You Modal -->
    <div id="thankYouModal" class="modal">
        <div class="modal-content">
            <!-- Add Image at the top -->
            <img src="/static/images/check.png" alt="Checkmark" style="width: 60px; height: 60px; display: block; margin: 20px auto 0 auto;">

            <h2>Thank you for your Order!</h2>
            <p>We have received your order and have sent you a text <br> message confirmation to {{ customer_phone_number }}.</p>
            <button type="button" onclick="submitForm()" id="confirmSubmit">OK </button>
        </div>
    </div>

{% include "footer.html" %}
</body>
</html>

<script>
    document.addEventListener("DOMContentLoaded", () => {
    const optionRadioButtons = document.querySelectorAll('input[name="option"]');
    const pickupDetailsSection = document.getElementById('pickupDetails');
    const optionButtons = document.querySelectorAll('.option-button');
    const addressSection = document.getElementById('address');
    const orderTypeRadios = document.querySelectorAll('input[name="order_type"]');
    const pickUpOptions = document.getElementById("pick_up_options");
    const deliveryOptions = document.getElementById("delivery_options");
    const deliveryAddressSection = document.getElementById("delivery_address_section");
    const deliveryFeeElement = document.getElementById('delivery-fee');
    const paymentRadioButtons = document.querySelectorAll('input[name="payment"]');
    const cardDetailsSection = document.getElementById("card-details");
	const pwdRadio = document.getElementById('pwd-radio');
    const seniorRadio = document.getElementById('senior-radio');
    const noneRadio = document.getElementById('none-radio');
    const discountDetails = document.getElementById('discount-details');
    const discountNameInput = document.getElementById('discount_name');
    const discountIdInput = document.getElementById('discount_id_number');
    const orderSummary = document.getElementById('order-summary');

    const cashPaymentRadio = document.getElementById("cash-payment");
    const gcashPaymentRadio = document.getElementById("gcash-payment");
    const gcashSection = document.getElementById('gcash-number-section');
    const gcashNumberInput = document.getElementById('gcash-number');

    const tenderedAmountSection = document.getElementById("tendered-amount-section");
    const tenderedAmountInput = document.getElementById("tendered_amount");
    const changeDisplay = document.getElementById('change-value');

    const cardNameInput = document.getElementById('card_name');
    const cardNumberInput = document.getElementById('card_number');
    const cvvInput = document.getElementById('cvv');

    const placeOrderButton = document.getElementById('place_order');
    const confirmButton = document.getElementById('confirmSubmit');


    // Event listener for order type selection
orderTypeRadios.forEach(radio => {
    radio.addEventListener("change", function () {
        if (this.value === "delivery") {
            // Show delivery options and fee
            deliveryOptions.style.display = "block";
            pickUpOptions.style.display = "none";
            deliveryAddressSection.style.display = "block";
            deliveryFeeElement.style.display = "block"; // Show delivery fee
        } else if (this.value === "pick_up") {
            // Show pick-up options
            pickUpOptions.style.display = "block";
            deliveryOptions.style.display = "none";
            deliveryAddressSection.style.display = "none"; // Hide delivery address
            deliveryFeeElement.style.display = "none"; // Hide delivery fee
            document.querySelector('input[name="address"]').removeAttribute("required"); // Remove required for pickup
        }
    });
});

// Event listener for delivery options
deliveryOptions.addEventListener("change", (event) => {
    if (event.target.name === "option") {
        if (event.target.value === "deliver_now" || event.target.value === "scheduled_delivery") {
            // Show delivery address and make it required
            deliveryAddressSection.style.display = "block";
            document.querySelector('input[name="address"]').setAttribute("required", "true");
        } else {
            // Hide delivery address and remove required attribute
            deliveryAddressSection.style.display = "none";
            document.querySelector('input[name="address"]').removeAttribute("required");
        }
    }
});


    // Initialize the page and load data
    initialize();

	function initialize() {
		setupEventListeners();
		loadCart();
		displaySelectedStore();
	}

	function displayStoreDetails() {
		const storeDetails = localStorage.getItem('selectedStore');

		if (storeDetails) {
			try {
				const store = JSON.parse(storeDetails);
				const pickupDetails = document.getElementById('pickupDetails');
				const pickupLocation = document.getElementById('pickup-location');

				if (store.name && store.address) {
					pickupLocation.textContent = `${store.name}, located at ${store.address}.`;
					pickupDetails.style.display = 'block';
					document.getElementById('store_name_hidden').value = store.name;
				} // Close if statement here
			} catch (error) {
				console.error("Error parsing store details:", error);
			}
		}
	}

	function editPickUpLocation() {
		console.log('Edit pick-up location triggered'); // Debug log

		// Get the current pick-up location value
		let currentLocation = document.getElementById('pickup-location').innerText;
		console.log('Current location:', currentLocation); // Debug log

		// Prompt user with a confirmation dialog (OK/Cancel)
		let changeLocation = confirm('Do you want to change the pick-up location?');

		// If the user clicked OK, allow them to select a new location or handle this logic
		if (changeLocation) {
			// Redirect to store pick-up location page to choose a new store
			const storePickUpUrl = "/stores"; // Adjust the URL as needed

			console.log('Redirecting to:', storePickUpUrl); // Debug log

			// Save the current location temporarily before redirection (optional)
			localStorage.setItem('previousPickupLocation', currentLocation);

			// Redirect to the store pick-up page
			window.location.href = storePickUpUrl;
		}
	}

	// Attach click event to the pencil icon
	document.addEventListener('DOMContentLoaded', () => {
		const editIcon = document.getElementById('edit-pickup-icon');
		if (editIcon) {
			console.log('Edit icon found. Adding click event listener.'); // Debug log
			editIcon.addEventListener('click', editPickUpLocation);
		} else {
			console.error('Edit icon not found in the DOM.');
		}
	});

	// Call the function on page load
	window.onload = displayStoreDetails;

    function displaySavedAddress() {
        if (!addressSection) {
            console.error("Element with ID 'address' not found.");
            return;
        }

        const storedDetails = JSON.parse(localStorage.getItem('deliveryDetails'));
        if (storedDetails) {
            const address = `${storedDetails.houseNumber} ${storedDetails.streetName}, ${storedDetails.subdivisionName ? storedDetails.subdivisionName + ', ' : ''}${storedDetails.barangay}, ${storedDetails.city}`;
            addressSection.textContent = address;
        } else {
            addressSection.textContent = 'No address saved';
        }
    }

    function displaySavedDeliveryInstruction() {
        const deliveryInstructionElement = document.getElementById('deliveryInstruction');
        if (!deliveryInstructionElement) {
            console.error("Element with ID 'deliveryInstruction' not found.");
            return;
        }

        const storedDetails = JSON.parse(localStorage.getItem('deliveryDetails'));
        if (storedDetails && storedDetails.deliveryInstruction) {
            deliveryInstructionElement.textContent = storedDetails.deliveryInstruction;
        } else {
            deliveryInstructionElement.textContent = 'No instructions provided';
        }
    }

    function displaySelectedStore() {
        if (!pickupDetailsSection) {
            console.error("Location not found");
            return;
        }

        const selectedStore = localStorage.getItem('selectedStore');
        if (selectedStore) {
            try {
                const storeDetails = JSON.parse(selectedStore);
                const storeDetailsText = `${storeDetails.name}, ${storeDetails.location}`;
                pickupDetailsSection.style.display = 'block';
				document.getElementById('store_name_hidden').value = storeDetails.name;

                const pickupLocationElement = document.getElementById('pickup-location');
                if (pickupLocationElement) {
                    pickupLocationElement.textContent = storeDetailsText;
                } else {
                    console.error("Element with ID 'pickup-location' not found.");
                }
            } catch (error) {
                console.error("Error parsing selectedStore from localStorage:", error);
            }
        } else {
            pickupDetailsSection.style.display = 'none';
        }
    }

   function toggleOptions(option) {
        console.log('Selected option:', option);
        console.log('Delivery section:', deliveryDetailsSection);
        console.log('Pickup section:', pickupDetailsSection);
        console.log('Address section:', addressSection);

        if (option === 'delivery') {
            // Show delivery details and address
            deliveryDetailsSection.style.display = 'block';
            pickupDetailsSection.style.display = 'none';
            addressSection.style.display = 'block'; // If needed, show address
        } else if (option === 'pickup') {
            // Show pickup details and hide delivery
            deliveryDetailsSection.style.display = 'none';
            pickupDetailsSection.style.display = 'block';
            addressSection.style.display = 'none'; // Optionally hide address for pickup
        } else {
            console.error('Invalid option passed to toggleOptions.');
        }
    }

    // Set up event listeners for option buttons
    function setupEventListeners() {
        if (optionButtons.length === 0) {
        }

        optionButtons.forEach(button => {
            button.addEventListener('click', (event) => {
            event.preventDefault();
            console.log('Button clicked:', button);
                const option = this.classList.contains('deliveryBtn') ? 'delivery' : 'pickup';
                toggleOptions(option); // Call toggleOptions when a button is clicked
                localStorage.setItem('currentSelection', option);
            });
        });


		// Payment method change listener
		paymentRadioButtons.forEach(button => {
			button.addEventListener('change', function() {
				if (this.value === "debit/creditcard") {
					cardDetailsSection.style.display = 'block';
					cardNameInput.required = true;
					cardNumberInput.required = true;
					cvvInput.required = true;
				} else {
					cardDetailsSection.style.display = 'none';
					cardNameInput.required = false;
					cardNumberInput.required = false;
					cvvInput.required = false;
				}


				if (this.value !== "cash") {
					tenderedAmountSection.style.display = 'none';
					tenderedAmountInput.value = '';
					changeDisplay.style.display = 'none';
					changeDisplay.innerText = `P0.00`; // Reset change to 0
				} else {
					tenderedAmountSection.style.display = 'block';
					changeDisplay.style.display = 'block';
					changeDisplay.innerText = `P0.00`; // Ensure change is reset for cash payment
				}
				if (this.value === "gcash") {
					gcashSection.style.display = 'block';
					gcashNumberInput.required = false; // Make GCash number input required
					} else {
					gcashSection.style.display = 'none';
					gcashNumberInput.required = false;
					gcashNumberInput.value = '';
				}
			});
		 });

	function updateDiscountDetails() {

	  if (noneRadio.checked) {
        discountDetails.style.display = 'none';
        discountNameInput.value = '';
        discountIdInput.value = '';
    }
    // If PWD or Senior is selected
    else if (pwdRadio.checked || seniorRadio.checked) {
        discountDetails.style.display = 'block';
        discountNameInput.placeholder = pwdRadio.checked ? "Enter your PWD full name" : "Enter your Senior full name";
        discountIdInput.placeholder = pwdRadio.checked ? "Enter your PWD ID number" : "Enter your Senior ID number";
    } else {
        // If none are selected, hide the discount details
        discountDetails.style.display = 'none';
        discountNameInput.value = '';
        discountIdInput.value = '';
    }

    loadCart(); // Reload the cart to reflect changes
	}

	// Event listeners for radio buttons
	pwdRadio.addEventListener('change', updateDiscountDetails);
	seniorRadio.addEventListener('change', updateDiscountDetails);
	noneRadio.addEventListener('change', updateDiscountDetails);

	// Example of a tendered amount input event listener
	tenderedAmountInput.addEventListener('input', updateChangeDisplay);

tenderedAmountInput.addEventListener('input', updateChangeDisplay);
    }
    function addMultipleKeyValuePairs(dataList, keyValuePairs) {
      dataList.push(Object.fromEntries(keyValuePairs));
      return dataList;
    }

    // Load cart items and update the order summary
    function loadCart() {
		const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
        const orderSummary = document.getElementById('order-summary');


        let totalItems = 0;
        let subtotal = 0;
        let vat = 0;
        let discount = 0;

        if (cartItems.length === 0) {
            orderSummary.innerHTML = '<p>Your cart is empty.</p>';

        } else {
            let orderSummaryHtml = '';
            let hiddenOrderSummary = '';
            itemIndex = 0

            cartItems.forEach(item => {
                const itemSubtotal = item.quantity * item.itemPrice;
                subtotal += itemSubtotal;
                totalItems += item.quantity;

				item_name = "item-name" + itemIndex
				item_subtotalName = "item-subtotal" + itemIndex
				item_priceName = "item-price" + itemIndex
				item_quantityName = "item-quantity" + itemIndex
				item_preferenceName = "item-preferences" + itemIndex
				item_preference = item.preferences ? item.preferences : "No preferences"

                orderSummaryHtml += `
                   <div>
                    <p class="item-name">
                        ${item.itemName}
                        <span class="item-subtotal">P${itemSubtotal.toFixed(2)}</span>
                        <span class="item-price">P${item.itemPrice.toFixed(2)}</span>
                        <span class="item-quantity">${item.quantity}</span>
                    </p>
                    <p class="item-preference">${item_preference}</p>
                </div>

                `;

                hiddenOrderSummary += `
					<input type="hidden" name=${item_name} value=${item.itemName}></input>
					<input type="hidden" name=${item_subtotalName} value=${itemSubtotal.toFixed(2)}></input>
					<input type="hidden" name=${item_priceName} value=${item.itemPrice.toFixed(2)}></input>
					<input type="hidden" name=${item_quantityName} value=${item.quantity} ></input>
					<input type="hidden" name=${item_preferenceName} value=${item_preference}></input>
                `;

                itemIndex += 1;
            });

				

            if (pwdRadio.checked || seniorRadio.checked) {
                discount = subtotal * 0.20;
                vat = 0;
            } else {
                vat = subtotal * 0.12;
                discount = 0;
            }

            const totalAmount = subtotal + vat - discount;

            orderSummary.innerHTML = orderSummaryHtml;
            document.getElementById('hidden-order-summary').innerHTML = hiddenOrderSummary;
            document.getElementById('total-items').innerText = totalItems;

            document.getElementById('Subtotal').innerText = `P${subtotal.toFixed(2)}`;
            document.getElementById('subtotal_hidden').value = subtotal.toFixed(2);

            document.getElementById('vat').innerText = `P${vat.toFixed(2)}`;
            document.getElementById('vat_hidden').value = vat.toFixed(2);

            document.getElementById('discount').innerText = `P${discount.toFixed(2)}`;
            document.getElementById('discount_hidden').value = discount.toFixed(2);

            document.getElementById('amount-due').innerText = `P${totalAmount.toFixed(2)}`;
            document.getElementById('amount_due_hidden').value = totalAmount.toFixed(2);
        }

        updateChangeDisplay();
    }

    // Update the change display based on the tendered amount
    function updateChangeDisplay() {
        tenderedAmountInput.addEventListener('input', function() {
            const tenderedAmount = parseFloat(this.value);
            const amountDue = parseFloat(document.getElementById('amount-due').innerText.replace('P', ''));

            if (!isNaN(tenderedAmount) && tenderedAmount >= amountDue) {
                const change = tenderedAmount - amountDue;
                changeDisplay.innerText = `P${change.toFixed(2)}`;
                document.getElementById('change_value_hidden').value = change.toFixed(2);
            } else if (!isNaN(tenderedAmount)) {
                changeDisplay.innerText = `Insufficient funds!`;
                document.getElementById('change_value_hidden').value = 0;
            } else {
                changeDisplay.innerText = `P0.00`;
                document.getElementById('change_value_hidden').value = 0;
            }
        });
    }

    // Function to check if a store is selected
	function checkSelectedBranch() {
    const selectedStore = JSON.parse(localStorage.getItem('selectedStore'));

    // If no store is selected, show the store selection prompt
    if (!selectedStore) {
        document.getElementById('store-selection-prompt').style.display = 'block';  // Show selection prompt
        document.getElementById('pickupDetails').style.display = 'none';  // Hide selected branch details
    } else {
        // If store is selected, show the selected branch details
        document.getElementById('store-selection-prompt').style.display = 'none';  // Hide selection prompt
        document.getElementById('pickupDetails').style.display = 'block';  // Show selected branch details

        // Update the pickup location text with the selected store's details
        const pickupLocation = document.getElementById('pickup-location');
        if (pickupLocation) {
            pickupLocation.textContent = `${selectedStore.name} at ${selectedStore.location}.`;
        }
    }
}

	// Function to reset the selected store and prompt user to select one
	function resetSelectedStore() {
		localStorage.removeItem('selectedStore');  // Remove the store from localStorage
		checkSelectedBranch();  // Recheck and show the prompt to select a store
	}

	// Call the checkSelectedBranch function when the page loads to determine the state of the selected store
	window.onload = function() {
		checkSelectedBranch();
	};


			function validatePayment() {
    const totalPriceElement = document.getElementById('amount_due_hidden');
    const totalPrice = parseFloat(totalPriceElement.value.trim()); // Get the numeric value of totalPrice
    const tenderedAmountInput = document.getElementById('tendered_amount'); // Ensure this is defined
    const tenderedAmount = parseFloat(tenderedAmountInput.value.trim()); // Get the numeric value of tenderedAmount

    // Log values to the console for debugging
    console.log('Tendered Amount:', tenderedAmount);
    console.log('Total Price:', totalPrice);

    // Check if the tendered amount is less than the total price
    if (tenderedAmount < totalPrice) {
        alert('Insufficient funds. Please provide an amount equal to or greater than the total price.');
        return false; // Exit if funds are insufficient
    }

    return true;
}

const form = document.getElementById('checkout-form');const modal = document.getElementById('thankYouModal');
function showModal() {
        if (validatePayment()) {
      	if (validateForm()) {
			modal.style.display = "block";
		} else {
			alert('Please fill out all required fields.');
		}

    } else {
        console.log('Payment validation failed');
    }
}

    const placeOrder = document.getElementById('place_order');
    placeOrder.addEventListener('click', showModal);

    function closeModal() {
		modal.style.display = "none";
    }

    function submitForm() {
		// Close the modal
		closeModal();

		// Submit the form
		form.submit();

		clearCart();


    // Reset the entire checkout process
    resetForm(form);

    // Reset the cart and cart display
    resetCart();

    // Reset the order summary
    resetOrderSummary();


    }

    const submitButton = document.getElementById('confirmSubmit');
    submitButton.addEventListener('click', submitForm);

    // Function to clear the cart
    function clearCart() {
        // If the cart is stored in localStorage, remove it
        localStorage.removeItem('cart');
        loadCart();  // Reload the cart to reflect the changes
    }


		const requiredFields = document.querySelectorAll('#checkout-form [required]');
// Reset Form Function
function resetForm(form) {
    form.reset(); // Reset all form fields

    // Reset dynamic content like address, order summary, and selected branch
    resetAddress();
    resetOrderSummary();
    resetSelectedBranch();  // Reset the selected branch
    resetDiscountFields();
}

// Reset Address fields (custom implementation based on your HTML structure)
function resetAddress() {
    const addressFields = document.querySelectorAll('#checkout-form .address');
    addressFields.forEach(field => {
        field.value = ''; // Clear address fields
    });
}

// Reset Order Summary (custom implementation based on your HTML structure)
function resetOrderSummary() {
    // Reset the pickup location message
    const pickupLocation = document.getElementById('pickup-location');
    if (pickupLocation) {
        pickupLocation.textContent = 'Pick up your order from the selected store.';  // Reset default message
    }

    // Reset order summary content
    const orderSummary = document.getElementById('order-summary');
    if (orderSummary) {
        orderSummary.innerHTML = ''; // Clear order summary content
    }

    // Reset the order details (items, subtotal, vat, discount, amount due, and change)
    document.getElementById('total-items').textContent = '0';
    document.getElementById('Subtotal').textContent = 'P0.00';
    document.getElementById('vat').textContent = 'P0.00';
    document.getElementById('discount').textContent = 'P0.00';
    document.getElementById('amount-due').textContent = 'P0.00';
    document.getElementById('change-value').textContent = 'P0.00';
}

// Reset Cart (custom function based on your cart structure)
function resetCart() {
    // If your cart data is stored in a global variable, clear it here
    cart = [];  // Resetting the cart (replace with actual cart reset logic)

    // If your cart data is stored in local storage, clear it
    localStorage.removeItem('cart');  // Remove the cart from local storage if it's there

    // Clear the cart display (if there's any UI element like a cart container)
    const cartContainer = document.getElementById('cart-container');
    if (cartContainer) {
        cartContainer.innerHTML = ''; // Clear the cart UI display
    }
}

function resetSelectedBranch() {
    // Remove the selected store from localStorage
    localStorage.removeItem('selectedStore');

    // Reset the selected branch display in the UI
    const pickupLocation = document.getElementById('pickup-location');
    if (pickupLocation) {
        pickupLocation.textContent = 'Pick up your order from the selected store.';  // Reset the message
    }

    // Reset the store selection UI (if needed)
    const storeSelectionPrompt = document.getElementById('store-selection-prompt');
    if (storeSelectionPrompt) {
        storeSelectionPrompt.style.display = 'none';  // Hide the store selection prompt if needed
    }

    // Optionally, hide the branch selection UI if it's not needed anymore
    const branchSelect = document.querySelector('select[name="branch"]');
    if (branchSelect) {
        branchSelect.style.display = 'none';  // Hide branch select dropdown if no store is selected
    } else {
        // If using radio buttons, hide them
        const branchRadioButtons = document.querySelectorAll('input[name="branch"]');
        branchRadioButtons.forEach(button => {
            button.style.display = 'none';  // Hide radio buttons for branch selection
        });
    }
}

// Reset Discount fields (if applicable)
function resetDiscountFields() {
    const discountFields = document.querySelectorAll('input[name="discount_name"], input[name="discount_id_number"]');
    discountFields.forEach(field => {
        field.value = ''; // Clear any discount-related fields
    });
}


// Form validation logic (unchanged)
function validateForm() {
    const requiredFields = document.querySelectorAll('#checkout-form [required]');
    let isValid = true;

    // Check if any required field is empty
    for (let field of requiredFields) {
        if (!field.value.trim()) {
            field.focus();
            alert('Please fill out all required fields.');  // Alert when a required field is empty
            isValid = false;
            break;  // Stop validation if a required field is empty
        }
    }

    if (!isValid) return false; // If any required field is not filled, return false

		function editAddress() {
			const currentAddress = document.getElementById('address').innerText;
			document.getElementById('editAddressText').value = currentAddress;
			document.getElementById('editAddressModal').style.display = 'block';
		}

		// Check if an order type is selected (Pick-Up or Delivery)
		const orderType = document.querySelector('input[name="order_type"]:checked');
		if (!orderType) {
			alert('Please select an order type (Pick-Up or Delivery).');
			return false;
		}
		if (orderType.value === "pick_up") {
        const pickUpOption = document.querySelector('input[name="option"]:checked');
        if (!pickUpOption) {
            alert("Please select a pick-up option (Pick-Up Now or Pick-Up Later).");
            return false;
        }
        if (pickUpOption.value === "scheduled") {
            const pickupDate = document.getElementById('pickup_date').value;
            const pickupTime = document.getElementById('pickup_time').value;
            if (!pickupDate || !pickupTime) {
                alert("Please provide a date and time for scheduled pick-up.");
                return false;
            }
        }
    } else if (orderType.value === "delivery") {
        const deliveryOption = document.querySelector('input[name="option"]:checked');
        if (!deliveryOption) {
            alert("Please select a delivery option (Deliver Now or Deliver Later).");
            return false;
        }
        if (deliveryOption.value === "scheduled_delivery") {
            const deliveryDate = document.getElementById('delivery_date').value;
            const deliveryTime = document.getElementById('delivery_time').value;
            const address = document.getElementById('address').value;
            if (!deliveryDate || !deliveryTime) {
                return false;
            }
        }
    }

    // Check if discount details are filled if a discount option is selected
    const discountOption = document.querySelector('input[name="discount-option"]:checked');

    if (discountOption) {
        const discountName = document.querySelector('input[name="discount_name"]').value.trim();
        const discountId = document.querySelector('input[name="discount_id_number"]').value.trim();


        // Ensure discount details are filled if PWD or Senior is selected
        if ((discountOption.value === 'PWD' || discountOption.value === 'Senior') && (!discountName || !discountId)) {
            alert('Please fill out the discount details.');
            return false;
        }
    } else {
        alert('No discount option selected');
    }

    // Check if payment is selected and validate specific payment details
    const paymentOption = document.querySelector('input[name="payment"]:checked');
    if (!paymentOption) {
        alert('Please select a payment method.');
        return false;
    }

      // For "Cash" payment method, check if tendered amount is filled
		if (paymentOption.value === 'cash') {
			const tenderedAmountInput = document.querySelector('input[name="tendered_amount"]').value.trim();
			// Check if the tendered amount is not a valid number
			if (tenderedAmountInput && isNaN(Number(tenderedAmountInput))) {
				alert('Please enter a valid tendered amount.');
				return false;
			}
		}

    // For "GCash" payment method, validate the phone number
    if (paymentOption.value === 'gcash') {
        const gcashNumber = document.querySelector('input[name="gcash-number"]').value.trim();
        const gcashError = document.getElementById('gcash-error');
        if (gcashNumber && !/^\d{11}$/.test(gcashNumber)) {
            gcashError.style.display = 'inline';
            return false;
        } else {
            gcashError.style.display = 'none';
        }
    }
		// Check if delivery address is filled when required
		const deliveryOption = document.querySelector('input[name="option"]:checked');
		if (deliveryOption && (deliveryOption.value === 'scheduled_delivery' || deliveryOption.value === 'deliver_now')) {
			const address = document.querySelector('input[name="address"]').value.trim();
			if (!address) {
				alert('Please enter a delivery address.');
				return false;
			}
		}

		return true;  // Return true if all fields are valid
	}

    loadCart();
  });
</script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>