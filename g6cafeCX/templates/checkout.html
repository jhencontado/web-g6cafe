<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G6 Cafe - Checkout</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <header>
        <section class="g6logo">
    <div class="g6logo">
        <a href="{{ url_for('home') }}">
            <img src="/static/images/g6logo.png" alt="g6logo">
        </a>
    </div>
</section>

        <nav>
            <a href="{{ url_for('menu') }}">Menu</a>
            <a href="{{ url_for('cart') }}">
    <img src="{{ url_for('static', filename='images/cart.png') }}" height="50px" width="50">
    <span id="cart-count">0</span>
    </a>
        </nav>
    </header>

    <section class="checkout">
        <h2>Checkout</h2>
        <div class="checkout-container">
            <!-- Checkout Form -->
            <form id="checkout-form" class="checkout-form" action="#" method="POST">
                <!-- Delivery Address Section (fetched from local storage) -->
                <h3>Delivery Information</h3>
                <img src="static/images/pencil.png" alt="Edit" class="edit-icon" onclick="editAddress()">
                <div id="deliveryDetails">
                    <span id="address">Loading address...</span>
                    <p id="delivery-instructions">No instructions provided</p>
                    <img src="static/images/pencil.png" alt="Edit" class="edit-icon" onclick="editDeliveryInstructions()">
                </div>
                <div id="editAddressModal" style="display:none;">
                <textarea id="editAddressText" rows="4" placeholder="Enter your address"></textarea>
                <button onclick="saveAddress()">Save</button>
                <button onclick="closeEditAddressModal()">Cancel</button>
            </div>

                <div id="editInstructionsModal" style="display:none;">
                    <textarea id="editInstructionsText" rows="4" placeholder="Enter your delivery instructions"></textarea>
                    <button onclick="saveDeliveryInstructions()">Save</button>
                    <button onclick="closeEditInstructionsModal()">Cancel</button>
                </div>

                <div id="pickupDetails" style="display: none;">
                <h3>Selected Branch</h3>
                    <img src="static/images/pencil.png" alt="Edit" class="edit-icon" onclick="editPickUpLocation()">
                <p id="pickup-location">Pick up your order from the selected store.</p>
                <a href="{{ url_for('storespick') }}" class="change-store-link">
                </a>
                </div>



                <!-- Personal Details -->
                <h3>Personal Details</h3>
                <label>Name: <input type="text" name="name" required></label>
                <label>Email: <input type="email" name="email"></label>
                <label>Contact Number: <input type="tel" name="contact" required></label>

                <!-- PWD/Senior Citizen Discount Section -->
                <h3>PWD/Senior Citizen Discount</h3>
                <label>
                    <input type="checkbox" id="discount-checkbox"> PWD or Senior Citizen
                </label>
                <div id="discount-details" style="display:none;">
                    <label>Full Name: <input type="text" name="discount_name" placeholder="Enter your full name" required></label>
                    <label>ID Number: <input type="text" name="discount_id_number" placeholder="Enter your ID number" required></label>
                </div>

                <!-- Payment Details -->
                <h3>Payment Option</h3>
                <label>
                    <input type="radio" name="payment" value="cash" id="cash-payment" required>
                    <span>Cash</span>
                </label>
                <!-- Tendered Amount Section (initially hidden) -->
                <div id="tendered-amount-section" style="display: none; margin-left: 20px;">
                    Tendered Amount: <input type="number" name="tendered_amount" id="tendered_amount" placeholder="Enter tendered amount">
                </div>

                <label>
                    <input type="radio" name="payment" value="gcash">
                    <span>GCash (Pay online)</span>
                </label>
                <label>
                    <input type="radio" name="payment" value="debit/creditcard">
                    <span>Debit/Credit Card (Pay online)</span>
                </label>


                <!-- Card Details (hidden by default) -->
                <div id="card-details" class="payment-details">
                    <h4>Card Details</h4>
                    <label>Name on Card: <input type="text" name="card_name" placeholder="Full Name on Card" required></label>
                    <label>Card Number: <input type="text" name="card_number" placeholder="1234 5678 9012 3456" required></label>
                    <div class="expiration-container">
                        <label>Expiration Month:
                            <select name="expiration_month" required>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </label>
                        <label>Expiration Year:
                            <select name="expiration_year" required>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                                <option value="2031">2031</option>
                                <option value="2032">2032</option>
                            </select>
                        </label>
                    </div>
                    <label>CVV: <input type="text" name="cvv" maxlength="3" placeholder="CVV" required></label>
                </div>

            </form>
        </div>
    </section>

    <!-- Order Summary -->
    <div class="order-summary">
    <div class="order-info">
        <h3>Order Details</h3>
    </div>
    <div id="order-summary"></div>

    <div class="order-details">
        <p>Total Items: <span id="total-items">0</span></p>
        <p>Subtotal: <span id="Subtotal">P0.00</span></p>
        <p>Vat: <span id="vat">P0.00</span></p>
        <p>PWD/SENIOR Discount: <span id="discount">P0.00</span></p>
        <p>Amount Due: <span id="amount-due">P0.00</span></p>
        <p id="change-amount">Change: <span id="change-value">P0.00</span></p>
    </div>
</div>

        <button type="submit">Place Order</button>
        <!-- Thank You Modal -->
<div id="thankYouModal" class="modal">
  <div class="modal-content">
    <!-- Add Image at the top -->
    <img src="/static/images/check.png" alt="Checkmark" style="width: 60px; height: 60px; display: block; margin: 20px auto 0 auto;">

    <h2>Thank you for your Order!</h2>
    <p>We have received your order and have sent you a text <br> message confirmation to {{ customer_phone_number }}</br>.</p>
      <a href="{{ url_for('home') }}">
          <button onclick="redirectToOrderStatus()">OK </button></a>
  </div>
</div>


</body>
</html>

    <script>
     document.addEventListener("DOMContentLoaded", () => {
    const optionRadioButtons = document.querySelectorAll('input[name="option"]');
    const deliveryDetailsSection = document.getElementById('deliveryDetails');
    console.log(localStorage.getItem('deliveryInstructions'));
    const pickupDetailsSection = document.getElementById('pickupDetails');
    const paymentRadioButtons = document.querySelectorAll('input[name="payment"]');
    const cardDetailsSection = document.getElementById("card-details");
    const discountCheckbox = document.getElementById("discount-checkbox");
    const discountDetailsSection = document.getElementById("discount-details");
    const cashPaymentRadio = document.getElementById("cash-payment");
    const tenderedAmountSection = document.getElementById("tendered-amount-section");
    const tenderedAmountInput = document.getElementById("tendered_amount");
    const changeDisplay = document.getElementById('change-amount');

    // Initialize the page and load data
    initialize();


    function initialize() {
    setupEventListeners();  // Set up event listeners for radio buttons, etc.
    loadCart();  // Load the cart and order summary on page load
    displaySavedAddress();  // Display saved delivery details (if any)
    displaySelectedStore();  // Display selected store information
    displaySavedDeliveryInstructions();  // Display saved delivery instructions (if any)
}

// Function to display saved address
function displaySavedAddress() {
    const storedDetails = JSON.parse(localStorage.getItem('deliveryDetails'));
    if (storedDetails) {
        const address = `${storedDetails.houseNumber} ${storedDetails.streetName}, ${storedDetails.subdivisionName ? storedDetails.subdivisionName + ', ' : ''}${storedDetails.barangay}, ${storedDetails.city}`;
        document.getElementById('address').textContent = address;
    } else {
        document.getElementById('address').textContent = 'No address saved';
    }
}

// Function to display saved delivery instructions
function displaySavedDeliveryInstructions() {
    const deliveryInstructionsElement = document.getElementById('delivery-instructions');
    if (!deliveryInstructionsElement) {
        console.error("Element with ID 'delivery-instructions' not found.");
        return;
    }

    const storedInstructions = localStorage.getItem('deliveryInstructions');
    if (storedInstructions) {
        deliveryInstructionsElement.textContent = storedInstructions;
    } else {
        deliveryInstructionsElement.textContent = 'No instructions provided';
    }
}

// Function to display selected store details in the Pick-Up Location section
function displaySelectedStore() {
    // Ensure the variable `pickupLocationSection` is defined
    const pickupLocationSection = document.getElementById('pickupDetails');
    if (!pickupLocationSection) {
        console.error("Element with ID 'pickupDetails' not found.");
        return;
    }

    const selectedStore = localStorage.getItem('selectedStore');
    if (selectedStore) {
        try {
            const storeDetails = JSON.parse(selectedStore);
            const storeDetailsText = `${storeDetails.name}, ${storeDetails.location}`;

            // Show the pickup details section and update with the selected store
            pickupLocationSection.style.display = 'block';
            const pickupLocationElement = document.getElementById('pickup-location');
            if (pickupLocationElement) {
                pickupLocationElement.textContent = `${storeDetailsText}`;
            } else {
                console.error("Element with ID 'pickup-location' not found.");
            }
        } catch (error) {
            console.error("Error parsing selectedStore from localStorage:", error);
        }
    } else {
        // Hide if no store is selected
        pickupLocationSection.style.display = 'none';
    }
}

    function setupEventListeners() {
        optionRadioButtons.forEach(button => {
            button.addEventListener('change', function() {
                if (this.value === "delivery") {
                console.log("Delivery selected");
                // Show delivery address section, hide pickup section
                deliveryAddressSection.style.display = 'block'; // Show delivery details
                pickupLocationSection.style.display = 'none';  // Hide pick-up details
                storeDisplay.style.display = 'none';          // Hide selected store details
            } else if (this.value === "pickup") {
                console.log("Pick-Up selected");
                // Show pickup section, hide delivery address section
                deliveryAddressSection.style.display = 'none'; // Hide delivery details
                pickupLocationSection.style.display = 'block'; // Show pick-up details
                storeDisplay.style.display = 'block';
                }
            });
        });

    paymentRadioButtons.forEach(button => {
        button.addEventListener('change', function() {
            if (this.value === "debit/creditcard") {
                cardDetailsSection.style.display = 'block';
            } else {
                cardDetailsSection.style.display = 'none';
            }

            if (this.value !== "cash") {
                tenderedAmountSection.style.display = 'none';
                tenderedAmountInput.value = '';
                changeDisplay.style.display = 'none';
                changeDisplay.innerText = `Change: P0.00`; // Reset change to 0
            } else {
                tenderedAmountSection.style.display = 'block';
                changeDisplay.style.display = 'block';
                changeDisplay.innerText = `Change: P0.00`; // Ensure change is reset for cash payment
            }
        });
    });

    discountCheckbox.addEventListener('change', function() {
        if (this.checked) {
            discountDetailsSection.style.display = 'block';
        } else {
            discountDetailsSection.style.display = 'none';
        }
        loadCart();
    });
}

// Load cart items and update the order summary
function loadCart() {
    const cartItems = JSON.parse(localStorage.getItem('cart')) || [];
    const orderSummary = document.getElementById('order-summary');
    const orderNumberElement = document.getElementById('order-number');
    let totalItems = 0;
    let subtotal = 0;
    let vat = 0;
    let discount = 0;

    if (cartItems.length === 0) {
        orderSummary.innerHTML = '<p>Your cart is empty.</p>';
        orderNumberElement.innerText = ''; // Clear the order number if cart is empty
    } else {
        let orderSummaryHtml = '';

        cartItems.forEach(item => {
            const itemSubtotal = item.quantity * item.itemPrice;
            subtotal += itemSubtotal;
            totalItems += item.quantity;

            orderSummaryHtml += `
                <div>
                    <p>${item.itemName} - P${item.itemPrice.toFixed(2)} x ${item.quantity} = P${itemSubtotal.toFixed(2)}</p>
                </div>
            `;
        });

        if (discountCheckbox.checked) {
            discount = subtotal * 0.20;
            vat = 0;
        } else {
            vat = subtotal * 0.12;
            discount = 0;
        }

        const totalAmount = subtotal + vat - discount;

        orderSummary.innerHTML = orderSummaryHtml;
        document.getElementById('total-items').innerText = totalItems;
        document.getElementById('Subtotal').innerText = `P${subtotal.toFixed(2)}`;
        document.getElementById('vat').innerText = `P${vat.toFixed(2)}`;
        document.getElementById('discount').innerText = `P${discount.toFixed(2)}`;
        document.getElementById('amount-due').innerText = `P${totalAmount.toFixed(2)}`;
    }

    updateChangeDisplay();
}

    // Update the change display based on the tendered amount
    function updateChangeDisplay() {
        tenderedAmountInput.addEventListener('input', function() {
            const tenderedAmount = parseFloat(this.value);
            const amountDue = parseFloat(document.getElementById('amount-due').innerText.replace('P', ''));

            if (!isNaN(tenderedAmount) && tenderedAmount >= amountDue) {
                const change = tenderedAmount - amountDue;
                changeDisplay.innerText = `Change: P${change.toFixed(2)}`;
            } else if (!isNaN(tenderedAmount)) {
                changeDisplay.innerText = `Insufficient funds!`;
            } else {
                changeDisplay.innerText = `Change: P0.00`;
            }
        });
    }


    // Trigger the Thank You modal when the "Place Order" button is clicked
document.querySelector("button[type='submit']").addEventListener("click", function(event) {
    event.preventDefault();  // Prevent the default form submission action

    // Clear the cart
    clearCart();

    // Show the Thank You modal
    showThankYouModal();
});

function showThankYouModal() {
    const modal = document.getElementById("thankYouModal");
    if (modal) {
        modal.style.display = "block";  // Show the modal
    }
}

function closeThankYouModal() {
    const modal = document.getElementById("thankYouModal");
    if (modal) {
        modal.style.display = "none";  // Hide the modal
    }
}

// Function to clear the cart
function clearCart() {
    // If the cart is stored in localStorage, remove it
    localStorage.removeItem('cart');  // Clears the cart data from localStorage

    // Optionally, clear the cart display in the HTML (e.g., an element with ID 'cartContainer')
    const cartContainer = document.getElementById('cartContainer');
    if (cartContainer) {
        cartContainer.innerHTML = '';  // Clear the cart display in HTML
    }
}

});
    function editAddress() {
        const currentAddress = document.getElementById('address').innerText;
        document.getElementById('editAddressText').value = currentAddress;
        document.getElementById('editAddressModal').style.display = 'block';
    }

    // Function to save the new address
    function saveAddress() {
        const newAddress = document.getElementById('editAddressText').value;
        document.getElementById('address').innerText = newAddress;

        // Save the new address to local storage
        localStorage.setItem('address', newAddress);

        closeEditAddressModal();
    }

    // Function to close the address edit modal
    function closeEditAddressModal() {
        document.getElementById('editAddressModal').style.display = 'none';
    }

    // Function to edit the delivery instructions
    function editDeliveryInstructions() {
        const currentInstructions = document.getElementById('delivery-instructions').innerText;
        document.getElementById('editInstructionsText').value = currentInstructions;
        document.getElementById('editInstructionsModal').style.display = 'block';
    }

    // Function to save the new delivery instructions
    function saveDeliveryInstructions() {
        const newInstructions = document.getElementById('editInstructionsText').value;
        document.getElementById('delivery-instructions').innerText = newInstructions;

        // Save the new delivery instructions to local storage
        localStorage.setItem('delivery-instructions', newInstructions);

        closeEditInstructionsModal();
    }
    function closeEditInstructionsModal() {
        document.getElementById('editInstructionsModal').style.display = 'none';
    }

    function editPickUpLocation() {
        // Get the current pick-up location value
        let currentLocation = document.getElementById('pickup-location').innerText;

        // Prompt user with a confirmation dialog (OK/Cancel)
        let changeLocation = confirm('Do you want to change the pick-up location?');

        // If the user clicked OK, allow them to select a new location or handle this logic
        if (changeLocation) {
            // Example: Directly update the location with a predefined value
            let newLocation = "New Location"; // Replace this with actual logic for selecting a new location

            // Update the pick-up location on the page
            document.getElementById('pickup-location').innerText = newLocation;

            // Optionally, save the updated pick-up location to localStorage
            localStorage.setItem('pickupLocation', newLocation);

            // Define the URL for the store pick-up page
            const storePickUpUrl = "/storespick";  // Adjust the URL as needed

            // Redirect to store pick-up location page to choose a new store
            window.location.href = storePickUpUrl;  // Redirect to the store pick-up page
        }
    }



    </script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>